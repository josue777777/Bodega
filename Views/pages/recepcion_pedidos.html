<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción de Pedidos</title>
    <link rel="stylesheet" href="../estilos/estilos.css">
</head>

<body>
    <header>
        <h1>Recepción de Pedidos</h1>
        <nav>
            <a href="index.html">Inicio</a>
        </nav>
    </header>

    <main>
        <label for="pedidoSelect">Seleccione un pedido:</label>
        <select id="pedidoSelect" onchange="mostrarPedido()">
            <option value="">-- Seleccione --</option>
        </select>

        <div id="detallePedido" style="display: none;">
            <h3>Detalle del Pedido</h3>
            <table border="1">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Solicitado</th>
                        <th>Recibido</th>
                    </tr>
                </thead>
                <tbody id="detalleTabla"></tbody>
            </table>
            <p id="resumenPedido" style="margin-top: 10px; font-weight: bold;"></p>
            <button onclick="guardarRecepcion()">Guardar Recepción</button>
        </div>
    </main>

    <script>
        let pedidos = [];
        let pedidoActual = null;

        function cargarPedidos() {
            pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
            const select = document.getElementById("pedidoSelect");
            select.innerHTML = "<option value=''>-- Seleccione --</option>";

            pedidos.forEach(p => {
                const option = document.createElement("option");
                option.value = p.idPedido;
                option.textContent = `Pedido #${p.idPedido} - Sede ${p.sede}`;
                select.appendChild(option);
            });

            console.log("Pedidos encontrados:", pedidos);
        }

        function obtenerNombreProducto(id) {
            const productos = JSON.parse(localStorage.getItem("productos")) || [];
            const encontrado = productos.find(p => p.id === id || p.id === parseInt(id));
            return encontrado ? `${encontrado.nombre} (ID ${encontrado.id})` : `ID ${id}`;
        }

        function mostrarPedido() {
            const idSeleccionado = document.getElementById("pedidoSelect").value;
            if (!idSeleccionado) return;

            pedidoActual = pedidos.find(p => String(p.idPedido) === idSeleccionado);
            const tabla = document.getElementById("detalleTabla");
            tabla.innerHTML = "";

            let completos = 0;

            pedidoActual.detalle.forEach((item, index) => {
                const alerta = item.cantidadRecibida < item.cantidadSolicitada ? 'style="background-color:#ffdddd"' : '';
                if (item.cantidadRecibida >= item.cantidadSolicitada) completos++;

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td ${alerta}>${obtenerNombreProducto(item.idProducto)}</td>
                    <td ${alerta}>${item.cantidadSolicitada}</td>
                    <td ${alerta}>
                        <input type="number" min="0" value="${item.cantidadRecibida}" onchange="actualizarCantidad(${index}, this.value)">
                    </td>
                `;
                tabla.appendChild(fila);
            });

            document.getElementById("resumenPedido").textContent = `Productos completos: ${completos} / ${pedidoActual.detalle.length}`;
            document.getElementById("detallePedido").style.display = "block";
        }

        function actualizarCantidad(index, valor) {
            pedidoActual.detalle[index].cantidadRecibida = parseInt(valor);
            mostrarPedido(); // Actualiza los colores y resumen
        }

        function guardarRecepcion() {
            const invalido = pedidoActual.detalle.some(d => isNaN(d.cantidadRecibida) || d.cantidadRecibida < 0);
            if (invalido) {
                alert("Verifique que todas las cantidades recibidas sean válidas (mayores o iguales a 0).");
                return;
            }

            const index = pedidos.findIndex(p => String(p.idPedido) === String(pedidoActual.idPedido));
            pedidos[index] = pedidoActual;
            localStorage.setItem("pedidos", JSON.stringify(pedidos));

            console.log("Generando factura para el pedido:", pedidoActual);
            generarFacturaRecepcion(pedidoActual); // ← Aquí se crea la factura

            alert("Recepción guardada correctamente");
            document.getElementById("detallePedido").style.display = "none";
            document.getElementById("pedidoSelect").value = "";
        }

        function generarFacturaRecepcion(pedido) {
            const facturas = JSON.parse(localStorage.getItem("facturasRecepcion")) || [];

            const nuevaFactura = {
                idFactura: facturas.length + 1,
                idPedido: pedido.idPedido,
                fechaRecepcion: new Date().toISOString().split('T')[0],
                sede: pedido.sede,
                detalle: pedido.detalle
            };

            facturas.push(nuevaFactura);
            localStorage.setItem("facturasRecepcion", JSON.stringify(facturas));
            console.log("Factura generada:", nuevaFactura);
        }

        window.onload = cargarPedidos;
    </script>
</body>

</html>