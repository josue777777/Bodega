<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Realizar Pedido</title>
  <link rel="stylesheet" href="../estilos/estilos.css" />
</head>
<body>
  <header>
    <h1>Realizar Pedido</h1>
    <nav>
      <a href="index.html">Inicio</a>
    </nav>
  </header>

  <main>
    <form>
      <label for="fecha">Fecha del pedido:</label>
      <input type="date" id="fecha" required />

      <label for="tipoPedido">Tipo de pedido:</label>
      <select id="tipoPedido" required>
        <option value="">Seleccione</option>
        <option value="27">Existencia</option>
        <option value="28">Encargo Bodega</option>
      </select>

      <label for="sede">Sede:</label>
      <select id="sede" required>
        <option value="">Seleccione</option>
        <option value="1">Central</option>
        <option value="2">Secundaria</option>
      </select>

      <h3>Agregar productos al pedido</h3>

      <label for="producto">Producto:</label>
      <select id="producto"></select>

      <label for="cantidad">Cantidad solicitada:</label>
      <input type="number" id="cantidad" min="1" />

      <button type="button" onclick="agregarProducto()">Agregar al pedido</button>

      <ul id="listaDetalle"></ul>

      <br />
      <button type="button" onclick="guardarPedido()">Guardar Pedido</button>
    </form>
  </main>

  <script>
    let detallePedido = [];

    function cargarProductos() {
      const productos = JSON.parse(localStorage.getItem("productos")) || [];
      const select = document.getElementById("producto");
      select.innerHTML = "<option value=''>Seleccione</option>";
      productos.forEach(p => {
        const option = document.createElement("option");
        option.value = p.id;
        option.textContent = `${p.nombre} (${p.descripcion})`;
        select.appendChild(option);
      });
    }

    function agregarProducto() {
      const productoId = document.getElementById("producto").value;
      const cantidad = parseInt(document.getElementById("cantidad").value);

      if (!productoId || isNaN(cantidad) || cantidad <= 0) {
        alert("Seleccione un producto y cantidad válida.");
        return;
      }

      // Verificar si ya está en el detalle
      const existente = detallePedido.find(p => p.idProducto === productoId);

      if (existente) {
        existente.cantidadSolicitada += cantidad;
      } else {
        detallePedido.push({
          idProducto: productoId,
          cantidadSolicitada: cantidad,
          cantidadRecibida: 0,
          estado: 1
        });
      }

      mostrarDetalle();
      document.getElementById("cantidad").value = "";
      document.getElementById("producto").value = "";
    }

    function mostrarDetalle() {
      const lista = document.getElementById("listaDetalle");
      lista.innerHTML = "";
      detallePedido.forEach((d, i) => {
        const item = document.createElement("li");
        item.textContent = `Producto ID ${d.idProducto} - Cantidad: ${d.cantidadSolicitada}`;
        lista.appendChild(item);
      });
    }

    function guardarPedido() {
      const fecha = document.getElementById("fecha").value;
      const tipoPedido = document.getElementById("tipoPedido").value;
      const sede = document.getElementById("sede").value;

      if (!fecha || !tipoPedido || !sede || detallePedido.length === 0) {
        alert("Complete todos los datos y agregue al menos un producto.");
        return;
      }

      const pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

      const nuevoPedido = {
        idPedido: pedidos.length + 1,
        fecha,
        tipoPedido,
        sede,
        estado: 1,
        detalle: detallePedido
      };

      pedidos.push(nuevoPedido);
      localStorage.setItem("pedidos", JSON.stringify(pedidos));

      alert("Pedido guardado con éxito");

      // Limpiar formulario
      detallePedido = [];
      document.getElementById("fecha").value = "";
      document.getElementById("tipoPedido").value = "";
      document.getElementById("sede").value = "";
      document.getElementById("cantidad").value = "";
      document.getElementById("producto").value = "";
      mostrarDetalle();
    }

    document.getElementById("tipoPedido").addEventListener("change", function () {
      const tipo = this.value;
      const sede = document.getElementById("sede");

      if (tipo === "27") {
        sede.value = "1";
        sede.disabled = true;
      } else {
        sede.disabled = false;
        sede.value = "";
      }
    });

    window.onload = cargarProductos;
  </script>
</body>
</html>